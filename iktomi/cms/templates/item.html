
{% macro buttons(is_popup=False) %}
<div class="buttons form-controls init-block" data-block-name="compact-buttons" data-compact-name="form-controls">
  <a class="compact-toggle" title="Компактный вид"></a>
  {% if not is_popup %}
    {% for action in actions %}
      {%- set action_url = stream.url_for(env, action.action, item=item.id) -%}
      <a href="{{ action_url }}"
         rel="{{ action.mode }}"
         {%- if action.hint %} title="{{ action.hint }}"{% endif %}
         {%- if action.item_lock %} data-item-lock="true"{% endif %}
         {%- if action.accepts_item_form %} data-item-form="true"{% endif %}
         class="button action-{{ action.action }}{% if action.cls %} icon-{{ action.cls}}{% endif %}">
        {{- action.title -}}
      </a>
    {% endfor -%}
  {% endif %}

  {% if save_allowed %}
  <div class="buttons__save-actions">
    {% if 'save_and_continue' in item_buttons %}
    <a href="" class="button icon-apply" rel="save-and-continue"
       data-item-lock="true"
       data-item-form="true">
      Сохранить
    </a>
    {% endif %}

    {% if (create_allowed and 'save_and_add_another' in item_buttons) or ('save' in item_buttons) %}
    <div class="buttons__save-hidden">
      {% if create_allowed and 'save_and_add_another' in item_buttons %}
      <a href="{{ stream.url_for(env, 'item', item=None).qs_set(filter_form.get_data()) }}"
         data-item-lock="true"
         data-item-form="true"
         class="button icon-add" rel="save-and-add">
        &hellip; и создать новый
      </a>
      {% endif %}

      {% if 'save' in item_buttons %}
      <a href="{{ stream_url }}" class="button icon-back" rel="save"
         data-item-lock="true"
         data-item-form="true">
        &hellip; и закрыть
      </a>
      {% endif %}
    </div>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endmacro %}


{% block content %}
<div class="init-block" data-block-name="title" data-title="{{ title }}"></div>
<div class="init-block" data-block-name="menu" data-menu="{{ menu }}"></div>

<form id="{{ form.id }}"
      class="init-block item-form{% if is_popup %} popup-form{% endif %}"
      action="{{ submit_url }}"
      method="post"
      enctype="multipart/form-data"
      data-block-name="item-form"
      {%- if autosave_allowed %}
      data-autosave="{{ stream.url_for(env, 'item.autosave', item=item.id) }}"
      {%- endif %}
      {%- if form.presavehooks is defined %} data-presavehooks="{{ ' '.join(form.presavehooks) }}"{% endif %}>
  <div class="content">
    <div class="header">
      <h1>
        {%- if is_popup %}
          {{- stream_title }}
        {%- else -%}
          <a href="{{ stream_url.qs_set(filter_form.get_data()) }}">{{ stream_title }}</a>
        {%- endif -%}
      </h1>

      {% block after_title %}{% endblock -%}
      {{ buttons(is_popup) }}

      {%- if context.item_trays is defined and item and item.id -%}
      <div class="trays init-block" data-block-name="item-trays"
           data-delete-url="{{ env.url_for('delete_from_tray') }}"
           data-stream-name="{{ stream.uid(env, version=False) }}"
           data-object-id="{{ item.id }}">
        <div class="trays__dropdown">
          <div class="trays__list">
          {%- for object_tray in context.item_trays(stream, item) -%}
          <div class="trays__tray tray{{ object_tray.tray.id % 24 }}" data-id="{{ object_tray.id }}">
            <a href="{{ url_for('tray', tray=object_tray.tray.id) }}">
              {{- object_tray.tray.title -}}
            </a>
            {%- if object_tray.comment -%}
              <div class="trays__comment-hellip">
                <div class="trays__comment">{{ object_tray.comment }}</div>
              </div>
            {%- endif -%}
            {%- if object_tray.can_delete(env.user) -%}
              <button type="button" class="trays__tray__remove">&times;</button>
            {%- endif -%}
          </div>
          {%- endfor -%}
          </div>
        </div>
        <button type="button" class="trays__add">+</button>
      </div>
      {%- endif -%}

      {% from "macros/autosave_status.html" import autosave_status %}
      {{ autosave_status(autosave_allowed, draft) }}
    </div>
    <div class="text">
      <div class="line"></div>
      <div class="form">
        {{ form.render() }}
      </div>
    </div>
  </div>

  {%- if item.id and item_lock -%}
    {% from 'macros/item_lock.html' import main as item_lock with context %}
    {{ item_lock(item, stream_url, lock_timeout, lock_message, edit_session) }}
  {%- endif -%}
</form>
{% endblock %}
