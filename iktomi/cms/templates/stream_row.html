{% macro list_field(name, field, item, url, loop) %}
    <td class="field_{{ name }}{% if field.classname is defined %} {{ field.classname }}{% endif %}">
      {% if field.link_to_item %}
          <a rel="id:{{ item.id }}" href="{{ url }}">
      {% endif %}
      {% set field_val = field(item, url, loop) %}

      {% if field_val.attrs is defined %}
          {% set attrs = field_val.attrs %}
      {% else %}
          {% set attrs = {} %}
      {% endif %}

      {% if field.image and field_val.url is defined %}
          <img src="{% if field.static -%}
                    {{ url_for_static(field_val.url) }}
                    {%- else -%}
                    {{- field_val.url -}}
                    {%- endif -%}" {{ attrs|xmlattr }} style="border: none;" />
      {% elif field.static %}
        <a href="{{ url_for_static(field_val.url) }}">{{ field_val }}</a>
      {% else %}
        {{ field_val }}
      {% endif %}
      {% if field.link_to_item %}
        </a>
      {% endif %}
    </td>
{% endmacro %}

{% macro lang_version(item, lang, field_val) %}
    {% set foreign_item = item|attr(lang) %}
    {% if foreign_item is not none %}
          <td {% if foreign_item.public is defined -%}
                   class="{%- if foreign_item.public -%}
                          published
                          {%- else -%}
                          unpublished
                          {%- endif -%}
               {%- endif %}">
            {% if foreign_item is iterable %}
            <ul class="langversion-links">
                {% for fi in foreign_item %}
                    <li>
                        <a href="{{ url_for(field_val, item=fi.id ) }}" target="_blank">
                          {{- fi.title -}}
                        </a>
                    </li>
                {% endfor %}
            </ul>
            {% else %}
                    <a href="{{ url_for(field_val, item=foreign_item.id ) }}" target="_blank">
                      {{- foreign_item.title -}}
                    </a>
            {% endif %}
        </td> 
    {% else %}
        <td></td>
    {% endif %}
{% endmacro %}

<tr class="item {{ row_cls }}{% if item.public is defined -%}
{%- if item.public %} published{% else %} unpublished{% endif -%}
{%- endif %}">
  {% block list_fields %}
      {% for name, field in list_fields.items() %}
          {% if name == 'en' or name == 'ru' %}
              {{ lang_version(item, name, field.transform(item[name])) }}
          {% else %}
              {{ list_field(name, field, item, url, loop) }}
          {% endif %}
      {% endfor %}  
  {% endblock %}
  {% block item_form %}
  {% if list_item_form is defined and list_item_form is not none %}

  {% set items_fieldlist = list_item_form.get_field('items') %}
  <td class="list-edit-item" style="width:1%">
    {% set index = row_index|string %}{# reqired to provide index as name, name MUST be string #}
    <input type="hidden" name="{{ items_fieldlist.indeces_input_name }}" value="{{ index }}" />
    {% set f = items_fieldlist.field(name=index) %}
    {% if f.error %}
    <div>
      <span class="error">{{ f.error }}</span>
    </div>
    {% endif %}
    {{ f.render() }}
    {#{ f.render(roles=roles) }#}
  </td>

  {% endif %}
  {% endblock %}
</tr>
